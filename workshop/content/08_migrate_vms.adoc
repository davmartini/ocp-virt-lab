:scrollbar:
:toc2:

=  Migration Toolkit for Virtualization

== Introduction

This lab uses the https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/[Migration Toolkit for Virtualization] (MTV) to import a virtual machine from VMware vSphere to OpenShift. The migration toolkit supports two "modes" of import:

* Cold migration turns off the source virtual machine before starting the migration. This is the default migration type.
* Warm migration copies data while the source virtual machine continues to run. Once the bulk of data has been migrated, the VM is shutdown and the final data is copied to the destination. The new VM can then be started, resulting in a much shorter period of downtime for the VM-hosted application.

The migration toolkit has already been deployed to your cluster using the Operator. Documentation for how to install and configure the Operator can be found https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/[here].

If you would like to learn more about how to configure the Migration Toolkit for Virtualization, please see https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.4/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites#rhv-prerequisites_mtv[here] for documentation with Red Hat Virtualization or https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.4/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites#vmware-prerequisites_mtv[here] for VMware vSphere.

== Prerequisites for the VMware Provider

////
The firewalls must enable traffic over the following ports:

. Network ports required for migrating from VMware vSphere
+
[cols="1,1,1,1,1"]
|===
|*Port*|*Protocol*|*Source*|*Destination*|*Purpose*
|443|TCP|OpenShift nodes|VMware vCenter|VMware provider inventory
Disk transfer authentication
|443|TCP|OpenShift nodes|VMware ESXi hosts|Disk transfer authentication
|902|TCP|OpenShift nodes|VMware ESXi hosts|Disk transfer data copy
|===
////

The following prerequisites apply to all migrations:

* ISO/CD-ROM disks must be unmounted.
* Each NIC must contain one IPv4 and/or one IPv6 address.
* The VM operating system must be certified and supported for use as a link:https://access.redhat.com/articles/973163#ocpvirt[guest operating system with OpenShift Virtualization].
* VM names must contain only lowercase letters (a-z), numbers (0-9), or hyphens (-), up to a maximum of 253 characters. The first and last characters must be alphanumeric. The name must not contain uppercase letters, spaces, periods (.), or special characters.
* VM names must not duplicate the name of an existing VM in the OpenShift Virtualization environment.

The *Migration Toolkit for Virtualization* will automatically assign a new name to a VM that does not comply with the rules. If this happens, MTV will automatically generate a new VM name to allow the migration to proceed smoothly.

== Migrating Virtual Machines from VMware

A three-tier application has been deployed on VMware for you to migrate to OpenShift.

The application consists of the following four virtual machines:

* One proxy system that redirects traffic to the web servers
* Two Microsoft Windows servers with IIS hosting a PHP application connecting to the database
* One Linux system running a MariaDB database

// WKTBD: Replace with actual link for each student
The application is accessible from the following link: http://webapp.vc.opentlc.com/

You will migrate three of the four virtual machines - you will not need to migrate the proxy (load balancer) VM because OpenShift handles network traffic and load balancing natively for VMs connected to the SDN.

=== Review the VMware environment

// WKTBD: Replace with link to student's individual account
. Navigate to link:https://portal.vc.opentlc.com/ui/app/folder;nav=v/urn:vmomi:Folder:group-d1:ee1bef3e-6179-4c1f-9d2a-004c7b0df4e5/vms/vms[https://portal.vc.opentlc.com^]

// WKTBD: replace with student's credentials
. Login with the user `%vcenter_user%@vc.opentlc.com` and the password `%vcenter_password%`

. Review the existing VMs
+
image::images/MTV/100_vSphere_VM_List.png[]
+
[NOTE]
The VMs with the suffix `_running` are the active ones. As for the migration have to be stopped, a clone of the VMs were created for the migration. Those VMs are the ones without that suffix.

. Review Segment navigating link:https://portal.vc.opentlc.com/ui/app/dvportgroup;nav=n/urn:vmomi:DistributedVirtualPortgroup:dvportgroup-1916:ee1bef3e-6179-4c1f-9d2a-004c7b0df4e5/ports[to this link^]
+
image::images/MTV/101_vSphere_Network.png[]

. Review storage navigating link:https://portal.vc.opentlc.com/ui/app/datastore;nav=s/urn:vmomi:Datastore:datastore-48:ee1bef3e-6179-4c1f-9d2a-004c7b0df4e5/vms/vms[to this link^]
+
image::images/MTV/102_vSphere_Datastore.png[]

=== Create the VMware provider to the migration toolkit

The *Migration Toolkit for Virtualization* (*MTV*) uses the VMware Virtual Disk Development Kit (*VDDK*) SDK to transfer virtual disks from VMware vSphere. This VDDK has already been set up for you in this environment.
////


. Navigate in the left menu to *Migration* -> *Providers for virtualization*
. Select project `openshift-mtv`
+
image::images/MTV/91_MTV_Providers.png[]
+
[TIP]
MTV 2.4 and later are project/namespace aware and do not require administrator privileges. You can delegate VM imports to application teams and VM users so that they can self-serve and migrate at their own pace!


. The lab is already configured with the VMWare provider named `vmware`.

////
. Navigate in the left menu to *Migration* -> *Providers for virtualization*
. Select project `openshift-mtv`

. By default, there is a provider called `host` which represents the *OpenShift Virtualization* as a target platform
+
image::images/MTV/92_MTV_Provider_list.png[]
+
However, you will need to register the source vCenter system to the Migration Toolkit for Virtualization as a new provider.


. Press *Create Provider* button in the top right. A dialog it will appear.
+
image::images/MTV/93_MTV_Create_Provider.png[]
+
// WKTBD: replace with student's credentials
. Select *VMware* on the *Provider type* dropdown and fill the following data:
.. *Name*: `vmware`
.. *vCenter host name or IP address*: `portal.vc.opentlc.com`
.. *vCenter user name*: `%vcenter_user%@vc.opentlc.com`
.. *vCenter password*: `%vcenter_password%`
.. *VDDK init image*: `image-registry.openshift-image-registry.svc:5000/openshift/vddk:latest`
.. *SHA-1 fingerprint*: `C7:BF:C2:DD:CD:73:1C:22:DC:D1:5A:DD:EA:64:21:C1:97:FB:F0:9C`
+
image::images/MTV/94_MTV_Fill_Dialog.png[]
.  Press *Create* and wait till the *Status* column is changed to `Ready`
+
image::images/MTV/95_MTV_Provider_Added.png[]

Now MTV knows about your VMware vSphere environment and can connect to it.


=== Create Storage and Network Mapping

Storage and networking are managed differently in VMware vSphere and Red Hat OpenShift. Therefore it is necessary to create a (simple) mapping from the source datastores and networks in VMware vSphere to the equivalent in OpenShift. This mapping will then be used to translate the VMware vSphere network and storage definitions to OpenShift network and storage definitions.

These only need to be configured once and are then reused in subsequent VM Migration Plans.

. Navigate in the left menu to *Migration* -> *NetworkMaps for virtualization* and press *Create NetworkMap*
+
image::images/MTV/96_MTV_NetworkMaps.png[]

. Fill in the following information in the appeared dialog. Press *Create*.
.. *Name*: `mapping-segment`
.. *Source provider*: `vmware`
.. *Target provider*: `host`
.. *Source networks*: `segment-migrating-to-ocpvirt`
.. *Target network*: `Pod network (default)`
+
image::images/MTV/97_Add_VMWARE_Mapping_Network.png[]

. Ensure the created mapping has the *Status* `Ready`
+
image::images/MTV/98_List_VMWARE_Mapping_Network.png[]

. Navigate in the left menu to *Migration* -> *StorageMaps for virtualization* and press *Create StorageMap*
+
image::images/MTV/99_MTV_StorageMaps.png[]

. Fill in the following information. Press *Create*.
.. *Name*: `mapping-datastore`
.. *Source provider*: `vmware`
.. *Target provider*: `host`
.. *Source storage*: `WorkloadDatastore`
.. *Target storage classs*: `ocs-storagecluster-ceph-rbd (default)`
+
image::images/MTV/100_Add_VMWARE_Mapping_Storage.png[]

. Ensure the created mapping has the *Status* `Ready`
+
image::images/MTV/101_List_VMWARE_Mapping_Storage.png[]

=== Create a Migration Plan

Now that you have the virtualization provider and the two mappings (network & storage) you can create a Migration Plan - this plan selects which VMs to migrate from VMware vSphere to Red Hat OpenShift Virtualization and how to execute the migration (cold/warm, network mapping, storage mapping, pre-/post-hooks, etc.).

. Navigate in the left menu to *Migration* -> *Plans for virtualization* and press *Create plan*
+
image::images/MTV/102_Create_VMWARE_Plan.png[]

. On the wizard fill the following information on the *General settings* step. Press *Next* when done.
.. *Plan name*: `move-webapp-vmware`
.. *Source provider*: `vmware`
.. *Target provider*: `host`
.. *Target namespace*: `vmexamples`
+
image::images/MTV/52_General_VMWARE_Plan.png[]

. On the next step, select `All datacenters`  and press *Next*
+
image::images/MTV/53_VM_Filter_VMWARE_Plan.png[]

. On the next step select  all the VMs. Press *Next*:
+
image::images/MTV/54_VM_Select_VMWARE_Plan.png[]

. On the *Network mapping* step select `mapping-segment` and press *Next*
+
image::images/MTV/55_Network_VMWARE_Plan.png[]

. On the *Storage mapping* step select `mapping-datastore` and press *Next*
+
image::images/MTV/56_Storage_VMWARE_Plan.png[]

. Press *Next* on the steps *Type* and *Hooks*

. Review the configuration specified and press *Finish*
+
image::images/MTV/57_Finish_VMWARE_Plan.png[]

. Ensure the status of the plan is *Ready*
+
image::images/MTV/58_Ready_VMWARE_Plan.png[]

. Press *Start* to begin the migration of the three VMs

. After around 10 minutes the migration is completed
+
image::images/MTV/59_Completed_VMWARE_Plan.png[]
+
[IMPORTANT]
====
Having many participants performing the same task in parallel can cause this task to perform slower than in a real environment. Please be patient.
====

=== Review and configure migrated Virtual Machines

Your VMs have now been migrated and can be started on OpenShift Virtualization. You could connect to the VM consoles and interact with them as you would in VMware vCenter.

However, the VMs are not connected to each other yet - this is because we connected the VMs to the SDN, which works a little bit differently than the external network the VMs were previously connected to.

A load balancer on OpenShift is called a *Service*. You will create this shortly. But the service selects the recipients of the traffic that it load balances via labels assigned to the targets. Currently, the VMs do not have a label assigned yet.

In order to successfully associate the  VMs with the Service, we need to do the following:

* Add a label to the VMs. We will use the same label for both Windows IIS servers because they are both behind the same load balancer.
* Create the service to make the two Windows IIS servers available for other workloads on the cluster. OpenShift will automatically make the load balancer internally accessible using the name of the Service as the DNS name.
* Make the service available outside of OpenShift by creating a *Route*.

. From the OpenShift console, navigate to *Virtualization* -> *VirtualMachines* and ensure the migrated VMs successfully imported and are running.
+
image::images/MTV/60_VMWARE_VMs_List.png[]
+
[NOTE]
====
Ensure you select the project `vmexamples`
====

. Access to the `winweb01` and navigate to the *YAML* tab.
. Find the `spec:` section and under the `template.metadata` add the following lines to label the VM resources:
+
[%nowrap]
----
      labels:
        env: webapp
----
+
[IMPORTANT]
====
Make sure to get the indentation exactly right - just like in the screenshot below.
====
+
image::images/MTV/61_VMWARE_VMs_YAML.png[]

. *Repeat* the process for the VM `winweb02`.

. Start the _Virtual Machines_ `database`, `winweb01` and `winweb02`
.. Ensure the VMs are properly working by accessing to the console tab of each VM.

. Navigate to *Networking* -> *Services* and press *Create Service*. Remember the label that you added to your VMs (`env=webapp`)? Here you see that the Service uses that label in its selector to pick which VMs to route traffic to.
. Replace the YAML with the following definition
+
[source,yaml]
----
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: vmexamples
spec:
  selector:
    env: webapp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
----

. Press *Create*.

. Now the Windows IIS are accessible from within the OpenShift cluster. Other virtual machines are able to access them using the DNS name `webapp.vmexamples`. However, since these web servers are the front end to an externally accessible application, we will expose them using a *Route*.
+
Navigate to *Networking* -> *Routes* in the left navigation menu. Press *Create Route* and fill the following information:
+
.. *Name*: `route-webapp`
.. *Service*: `webapp`
.. *Target port*: `80 -> 80 (TCP)`
. Press *Create*
+
[NOTE]
====
OpenShift can automatically (re)encrypt traffic entering the cluster via a Route, however, we don't need to use TLS for this application. The *Secure Route* option should not be checked.
====
+
image::images/MTV/63_VMWARE_VMs_Create_Route.png[]

. Navigate to the address shown in *Location* field
+
image::images/MTV/64_VMWARE_VMs_URL.png[]

. When the page loads, you will see an error. This is because the Windows web servers are not able to resolve the internal name `database` to connect to the database VM.
+
To fix the connectivity issue, we need to create another Service for the database VM so that it is discoverable by other VMs connected to the SDN. Note that because this database does *not* need to be accessible from outside of the OpenShift environment, you do not need to create a route for this service.
+
Navigate to *Networking* -> *Services* and press *Create service*. Replace the YAML with the following definition
+
[source,yaml]
----
apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: vmexamples
spec:
  selector:
    vm.kubevirt.io/name: database
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 3306
----
+
[NOTE]
====
In this example the service is simply using a selector of the VM's name. This is a default label that is automatically added to all VMs. Since there is only one VM that matches the selector, the service will not load balance to the database, instead we're using the Service for discovery via the internal DNS name.
====

. Reload the webapp URL and expect to get the proper result
+
image::images/MTV/65_VMWARE_VMs_URL.png[]

== Summary

In addition to the Migration Toolkit for Virtualization, there are three other migration toolkits. The combination of these can be used to move many workloads into and within OpenShift clusters depending on your organization's needs. 

* https://developers.redhat.com/products/mtr/overview[Migration Toolkit for Runtimes] - Assist and accelerate Java application modernization and migration.
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/[Migration Toolkit for Applications] - Accelerate large-scale application modernization efforts to containers and Kubernetes.
* https://docs.openshift.com/container-platform/4.12/migration_toolkit_for_containers/about-mtc.html[Migration Toolkit for Containers] - Migrate stateful application workloads between OpenShift clusters.

For more information about these, please reach out to your Red Hat account team.

In this module, you explored how to migrate virtual machines from VMware vSphere to Red Hat OpenShift Virtualization. You have migrated a web application containing two Windows systems and a Linux system. You used OpenShift features to provide networking access to the application, and you learned to create services to provide access internal in the project.
